// http://paulirish.com/2011/requestanimationframe-for-smart-animating/
// http://my.opera.com/emoller/blog/2011/12/20/requestanimationframe-for-smart-er-animating

// requestAnimationFrame polyfill by Erik MÃ¶ller. fixes from Paul Irish and Tino Zijdel

// MIT license

(function() {
    var lastTime = 0;
    var vendors = ['ms', 'moz', 'webkit', 'o'];
    for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
        window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
        window.cancelAnimationFrame = window[vendors[x]+'CancelAnimationFrame']
                                   || window[vendors[x]+'CancelRequestAnimationFrame'];
    }

    if (!window.requestAnimationFrame)
        window.requestAnimationFrame = function(callback, element) {
            var currTime = new Date().getTime();
            var timeToCall = Math.max(0, 16 - (currTime - lastTime));
            var id = window.setTimeout(function() { callback(currTime + timeToCall); },
              timeToCall);
            lastTime = currTime + timeToCall;
            return id;
        };

    if (!window.cancelAnimationFrame)
        window.cancelAnimationFrame = function(id) {
            clearTimeout(id);
        };
}());



/*! npm.im/iphone-inline-video 2.0.2 */

var enableInlineVideo=function(){"use strict";/*! npm.im/intervalometer */
function e(e,i,n,r){function t(n){d=i(t,r),e(n-(a||n)),a=n}var d,a;return{start:function(){d||t(0)},stop:function(){n(d),d=null,a=0}}}function i(i){return e(i,requestAnimationFrame,cancelAnimationFrame)}function n(e,i,n,r){function t(i){Boolean(e[n])===Boolean(r)&&i.stopImmediatePropagation(),delete e[n]}return e.addEventListener(i,t,!1),t}function r(e,i,n,r){function t(){return n[i]}function d(e){n[i]=e}r&&d(e[i]),Object.defineProperty(e,i,{get:t,set:d})}function t(e,i,n){n.addEventListener(i,function(){return e.dispatchEvent(new Event(i))})}function d(e,i){Promise.resolve().then(function(){e.dispatchEvent(new Event(i))})}function a(e){var i=new Audio;return t(e,"play",i),t(e,"playing",i),t(e,"pause",i),i.crossOrigin=e.crossOrigin,i.src=e.src||e.currentSrc||"data:",i}function o(e,i,n){(m||0)+200<Date.now()&&(e[b]=!0,m=Date.now()),n||(e.currentTime=i),w[++T%3]=100*i|0}function u(e){return e.driver.currentTime>=e.video.duration}function s(e){var i=this;i.video.readyState>=i.video.HAVE_FUTURE_DATA?(i.hasAudio||(i.driver.currentTime=i.video.currentTime+e*i.video.playbackRate/1e3,i.video.loop&&u(i)&&(i.driver.currentTime=0)),o(i.video,i.driver.currentTime)):i.video.networkState===i.video.NETWORK_IDLE&&0===i.video.buffered.length&&i.video.load(),i.video.ended&&(delete i.video[b],i.video.pause(!0))}function c(){var e=this,i=e[h];return e.webkitDisplayingFullscreen?void e[g]():("data:"!==i.driver.src&&i.driver.src!==e.src&&(o(e,0,!0),i.driver.src=e.src),void(e.paused&&(i.paused=!1,0===e.buffered.length&&e.load(),i.driver.play(),i.updater.start(),i.hasAudio||(d(e,"play"),i.video.readyState>=i.video.HAVE_ENOUGH_DATA&&d(e,"playing")))))}function v(e){var i=this,n=i[h];n.driver.pause(),n.updater.stop(),i.webkitDisplayingFullscreen&&i[E](),n.paused&&!e||(n.paused=!0,n.hasAudio||d(i,"pause"),i.ended&&(i[b]=!0,d(i,"ended")))}function p(e,n){var r=e[h]={};r.paused=!0,r.hasAudio=n,r.video=e,r.updater=i(s.bind(r)),n?r.driver=a(e):(e.addEventListener("canplay",function(){e.paused||d(e,"playing")}),r.driver={src:e.src||e.currentSrc||"data:",muted:!0,paused:!0,pause:function(){r.driver.paused=!0},play:function(){r.driver.paused=!1,u(r)&&o(e,0)},get ended(){return u(r)}}),e.addEventListener("emptied",function(){var i=!r.driver.src||"data:"===r.driver.src;r.driver.src&&r.driver.src!==e.src&&(o(e,0,!0),r.driver.src=e.src,i?r.driver.play():r.updater.stop())},!1),e.addEventListener("webkitbeginfullscreen",function(){e.paused?n&&0===r.driver.buffered.length&&r.driver.load():(e.pause(),e[g]())}),n&&(e.addEventListener("webkitendfullscreen",function(){r.driver.currentTime=e.currentTime}),e.addEventListener("seeking",function(){w.indexOf(100*e.currentTime|0)<0&&(r.driver.currentTime=e.currentTime)}))}function l(e){var i=e[h];e[g]=e.play,e[E]=e.pause,e.play=c,e.pause=v,r(e,"paused",i.driver),r(e,"muted",i.driver,!0),r(e,"playbackRate",i.driver,!0),r(e,"ended",i.driver),r(e,"loop",i.driver,!0),n(e,"seeking"),n(e,"seeked"),n(e,"timeupdate",b,!1),n(e,"ended",b,!1)}function f(e,i){if(void 0===i&&(i={}),!e[h]){if(!i.everywhere){if(!y)return;if(!(i.iPad||i.ipad?/iPhone|iPod|iPad/:/iPhone|iPod/).test(navigator.userAgent))return}!e.paused&&e.webkitDisplayingFullscreen&&e.pause(),p(e,!e.muted),l(e),e.classList.add("IIV"),e.muted&&e.autoplay&&e.play(),/iPhone|iPod|iPad/.test(navigator.platform)||console.warn("iphone-inline-video is not guaranteed to work in emulated environments")}}var m,y="object"==typeof document&&"object-fit"in document.head.style&&!matchMedia("(-webkit-video-playable-inline)").matches,h="bfred-it:iphone-inline-video",b="bfred-it:iphone-inline-video:event",g="bfred-it:iphone-inline-video:nativeplay",E="bfred-it:iphone-inline-video:nativepause",w=[],T=0;return f}();



/**
 * jquery-circle-progress - jQuery Plugin to draw animated circular progress bars:
 * {@link http://kottenator.github.io/jquery-circle-progress/}
 *
 * @author Rostyslav Bryzgunov <kottenator@gmail.com>
 * @version 1.2.2
 * @licence MIT
 * @preserve
 */
!function(i){if("function"==typeof define&&define.amd)define(["jquery"],i);else if("object"==typeof module&&module.exports){var t=require("jquery");i(t),module.exports=t}else i(jQuery)}(function(i){function t(i){this.init(i)}t.prototype={value:0,size:100,startAngle:-Math.PI,thickness:"auto",fill:{gradient:["#3aeabb","#fdd250"]},emptyFill:"rgba(0, 0, 0, .1)",animation:{duration:1200,easing:"circleProgressEasing"},animationStartValue:0,reverse:!1,lineCap:"butt",insertMode:"prepend",constructor:t,el:null,canvas:null,ctx:null,radius:0,arcFill:null,lastFrameValue:0,init:function(t){i.extend(this,t),this.radius=this.size/2,this.initWidget(),this.initFill(),this.draw(),this.el.trigger("circle-inited")},initWidget:function(){this.canvas||(this.canvas=i("<canvas>")["prepend"==this.insertMode?"prependTo":"appendTo"](this.el)[0]);var t=this.canvas;if(t.width=this.size,t.height=this.size,this.ctx=t.getContext("2d"),window.devicePixelRatio>1){var e=window.devicePixelRatio;t.style.width=t.style.height=this.size+"px",t.width=t.height=this.size*e,this.ctx.scale(e,e)}},initFill:function(){function t(){var t=i("<canvas>")[0];t.width=e.size,t.height=e.size,t.getContext("2d").drawImage(g,0,0,r,r),e.arcFill=e.ctx.createPattern(t,"no-repeat"),e.drawFrame(e.lastFrameValue)}var e=this,a=this.fill,n=this.ctx,r=this.size;if(!a)throw Error("The fill is not specified!");if("string"==typeof a&&(a={color:a}),a.color&&(this.arcFill=a.color),a.gradient){var s=a.gradient;if(1==s.length)this.arcFill=s[0];else if(s.length>1){for(var l=a.gradientAngle||0,o=a.gradientDirection||[r/2*(1-Math.cos(l)),r/2*(1+Math.sin(l)),r/2*(1+Math.cos(l)),r/2*(1-Math.sin(l))],h=n.createLinearGradient.apply(n,o),c=0;c<s.length;c++){var d=s[c],u=c/(s.length-1);i.isArray(d)&&(u=d[1],d=d[0]),h.addColorStop(u,d)}this.arcFill=h}}if(a.image){var g;a.image instanceof Image?g=a.image:(g=new Image,g.src=a.image),g.complete?t():g.onload=t}},draw:function(){this.animation?this.drawAnimated(this.value):this.drawFrame(this.value)},drawFrame:function(i){this.lastFrameValue=i,this.ctx.clearRect(0,0,this.size,this.size),this.drawEmptyArc(i),this.drawArc(i)},drawArc:function(i){if(0!==i){var t=this.ctx,e=this.radius,a=this.getThickness(),n=this.startAngle;t.save(),t.beginPath(),this.reverse?t.arc(e,e,e-a/2,n-2*Math.PI*i,n):t.arc(e,e,e-a/2,n,n+2*Math.PI*i),t.lineWidth=a,t.lineCap=this.lineCap,t.strokeStyle=this.arcFill,t.stroke(),t.restore()}},drawEmptyArc:function(i){var t=this.ctx,e=this.radius,a=this.getThickness(),n=this.startAngle;i<1&&(t.save(),t.beginPath(),i<=0?t.arc(e,e,e-a/2,0,2*Math.PI):this.reverse?t.arc(e,e,e-a/2,n,n-2*Math.PI*i):t.arc(e,e,e-a/2,n+2*Math.PI*i,n),t.lineWidth=a,t.strokeStyle=this.emptyFill,t.stroke(),t.restore())},drawAnimated:function(t){var e=this,a=this.el,n=i(this.canvas);n.stop(!0,!1),a.trigger("circle-animation-start"),n.css({animationProgress:0}).animate({animationProgress:1},i.extend({},this.animation,{step:function(i){var n=e.animationStartValue*(1-i)+t*i;e.drawFrame(n),a.trigger("circle-animation-progress",[i,n])}})).promise().always(function(){a.trigger("circle-animation-end")})},getThickness:function(){return i.isNumeric(this.thickness)?this.thickness:this.size/14},getValue:function(){return this.value},setValue:function(i){this.animation&&(this.animationStartValue=this.lastFrameValue),this.value=i,this.draw()}},i.circleProgress={defaults:t.prototype},i.easing.circleProgressEasing=function(i){return i<.5?(i=2*i,.5*i*i*i):(i=2-2*i,1-.5*i*i*i)},i.fn.circleProgress=function(e,a){var n="circle-progress",r=this.data(n);if("widget"==e){if(!r)throw Error('Calling "widget" method on not initialized instance is forbidden');return r.canvas}if("value"==e){if(!r)throw Error('Calling "value" method on not initialized instance is forbidden');if("undefined"==typeof a)return r.getValue();var s=arguments[1];return this.each(function(){i(this).data(n).setValue(s)})}return this.each(function(){var a=i(this),r=a.data(n),s=i.isPlainObject(e)?e:{};if(r)r.init(s);else{var l=i.extend({},a.data());"string"==typeof l.fill&&(l.fill=JSON.parse(l.fill)),"string"==typeof l.animation&&(l.animation=JSON.parse(l.animation)),s=i.extend(l,s),s.el=a,r=new t(s),a.data(n,r)}})}});



// telescope.js

function videoObj(el) {
  if (el.tagName !== 'VIDEO') {
    var video_el = $(el).data('_el');
    if (!video_el) {
      video_el = $(el).closest('.ts-post').find('video').get(0);
      $(el).data('_el', video_el);
    }
    el = video_el;
  }
  var $video = $(el);
  var video = $video.data('_obj');
  if (!video) {
    video = {};
    video.el              = el;
    video.$el             = $video;
    video.$postWrap       = $video.closest('.ts-post');
    video.$videoCont      = $('.ts-video-container', video.$postWrap);
    video.$videoWrap      = $('.ts-video-wrap', video.$postWrap);
    video.$videoDuration  = $('.ts-video-duration', video.$postWrap);
    video.$progress       = $('.ts-progress', video.$videoCont);
    video.$postDate       = $('.ts-post-date', video.$postWrap);
    video.$videoClickable = $('.ts-video-clickable', video.$postWrap);
    video.$shareButton    = $('.ts-video-share', video.$postWrap);
    video.$el.data('_obj', video);

    video.$progress.circleProgress({
      value:      0,
      size:       272,
      startAngle: -Math.PI / 2,
      thickness:  4,
      lineCap:    'round',
      fill:       '#131313',
      emptyFill:  'transparent',
      animation:  false
    });

    video.el && enableInlineVideo(video.el);
    video.$el.on('timeupdate', onVideoPosterHidden);
    video.$el.on('ended', onVideoEnded);
    video.$videoClickable.on('click', onVideoClick);
    video.$shareButton.on('click', function(e){
      e.preventDefault();
      openShareVideo(video);
    });

    var date = video.$postDate.attr('data-value');
    var date_formated = formatLocalDate(date);
    if (date_formated) {
      video.$postDate.text(date_formated);
    }
  }
  return video;
}

function setProgress(video, progress) {
  if (progress > 1) progress = 1;
  if (progress < 0) progress = 0;
  video.$progress.circleProgress('value', progress);
  if (video.el.duration) {
    var duration = video.el.duration - video.el.currentTime;
    video.$videoDuration.text(formatDuration(duration));
  }
}

function formatDuration(duration) {
  var m = Math.floor(duration / 60);
  var s = Math.floor(duration % 60);
  return m + ':' + (s < 10 ? '0' + s : s);
}

function formatLocalDate(time) {
  try {
    return (new Date(time * 1e3)).toLocaleDateString('en-US', {
      day:    'numeric',
      month:  'short',
      hour:   'numeric',
      minute: 'numeric'
    }).split(', ').join(' at ');
  } catch(e) {}
  return false;
}

function freezeVideo(video) {
  video.$videoCont.removeClass('ts-video-playing');
  video.playing = false;
  video.freezed = true;
  video.el.muted = true;
  video.el.loop = true;
  video.el.currentTime = 0;
  videoPause(video.el);
  showVideoProgress(video);
}

function unfreezeVideo(video) {
  video.$videoCont.removeClass('ts-video-playing');
  video.playing = false;
  video.freezed = false;
  video.el.muted = true;
  video.el.loop = true;
  video.el.currentTime = 0;
  videoPlay(video.el);
  showVideoProgress(video);
}

function showVideoProgress(video) {
  if (video.playing && !video.el.paused) {
    requestAnimationFrame(function(){ showVideoProgress(video); });
  }
  setProgress(video, video.el.currentTime / video.el.duration);
}

function videoPlay(el) {
  var isPlaying = el.currentTime > 0 && !el.paused && !el.ended
    && el.readyState > 2;
  if (!isPlaying) el.play();
}

function videoPause(el) {
  el.pause();
}

function toggleVideo(video) {
  if (!video.playing) {
    video.$videoCont.addClass('ts-video-playing');
    video.playing = true;
    video.el.muted = false;
    video.el.loop = false;
    video.el.currentTime = 0;
    videoPlay(video.el);
    showVideoProgress(video);
  } else {
    if (video.el.paused) {
      videoPlay(video.el);
      showVideoProgress(video);
    } else {
      videoPause(video.el);
    }
  }
}

function startPlayback(video) {
  var videos = document.getElementsByTagName('video');
  for (var i = 0; i < videos.length; i++) {
    if (videos[i] !== video.el) {
      freezeVideo(videoObj(videos[i]));
    }
  };
  toggleVideo(video);
}

function stopPlayback() {
  var videos = document.getElementsByTagName('video');
  for (var i = 0; i < videos.length; i++) {
    unfreezeVideo(videoObj(videos[i]));
  };
}

function getNextVideo(video) {
  var videos = document.getElementsByTagName('video');
  for (var i = 0; i < videos.length; i++) {
    if (videos[i] === video.el) {
      return videos[i + 1] ? videoObj(videos[i + 1]) : false;
    }
  }
  return false;
}

function initVideos() {
  var videos = document.getElementsByTagName('video');
  for (var i = 0; i < videos.length; i++) {
    videoObj(videos[i]);
  }
}

function mobileInitVideos() {
  var videos = document.getElementsByTagName('video');
  for (var i = 0; i < videos.length; i++) {
    var video = videoObj(videos[i]);
    if (!video.mInited && video.el.buffered.length && video.el.buffered.end(0)) {
      videoPlay(video.el);
      videoPause(video.el);
      video.mInited = true;
    }
  }
}

function optimizeVideosOnScroll() {
  var videos = document.getElementsByTagName('video');
  for (var i = 0; i < videos.length; i++) {
    var video = videoObj(videos[i]);
    if (!video.freezed) {
      if (isVideoVisible(video)) {
        if (video.el.paused) {
          videoPlay(video.el);
        }
      } else {
        if (!video.el.paused) {
          videoPause(video.el);
        }
      }
    }
  }
}

function updateHeader() {
  var st = $(document).scrollTop() - 15;
  if ($(document).width() > 320) {
    if (st > 25.6) st = 25.6;
    if (st < 0)  st = 0;
    var s = (1 - st / 25.6 * 0.4);
    var m = -((1 - s) / 2) / s * 100;
  } else {
    if (st > 12.5) st = 12.5;
    if (st < 0)  st = 0;
    var s = (1 - st / 12.5 * 0.25);
    var m = -((1 - s) / 2) / s * 100;
  }
  $('.ts-header').toggleClass('ts-header-shadow', st > 0);
  $('.ts-header').css('transform', 'translateY(' + (-st) + 'px)');
  $('.ts-header .ts-logo, .ts-header .ts-title').css('transform', 'scale3d(' + s + ', ' + s + ', 1)');
  $('.ts-header .ts-logo, .ts-header .ts-title');
  $('.ts-header .ts-title').css('margin', '0 ' + m + '%');
}

function initScroll() {
  $(document).on('scroll', function() {
    optimizeVideosOnScroll();
    $before = $('.ts-post-more[data-before]');
    $after  = $('.ts-post-more[data-after]');
    if ($before.length) {
      var bottom = $before.offset().top - $(document).scrollTop() + $before.height();
      if (bottom > -700) {
        loadMore($before);
      }
    }
    if ($after.length) {
      var top = $after.offset().top - $(document).scrollTop();
      if (top < $(window).height() + 700) {
        loadMore($after);
      }
    }
    updateHeader();
  });
  updateHeader();
}

function setVideoUrl(video, replace) {
  if (!window.history) return;
  if ($('body').hasClass('ts-embed')) return;
  if (video) {
    var video_url = video.$postWrap.attr('data-url');
    if (document.location.pathname != video_url) {
      if (replace) {
        history.replaceState(null, null, video_url);
      } else {
        history.pushState(null, null, video_url);
      }
    }
  } else {
    var feed_url = $('.ts-feed').attr('data-url');
    history.pushState(null, null, feed_url);
  }
}

function onVideoClick(e) {
  e.preventDefault();
  mobileInitVideos();
  var video = videoObj(this);
  startPlayback(video);
  setVideoUrl(video);
}

function onVideoPosterHidden(e) {
  var video = videoObj(this);
  if (!video.preloaded) {
    video.preloaded = true;
    video.$el.addClass('ts-video-preloaded');
  }
}

function onVideoEnded(e) {
  var video = videoObj(this);
  var next_video = getNextVideo(video);
  if (!next_video) {
    stopPlayback();
    setVideoUrl();
  } else {
    var playNextVideo = function() {
      startPlayback(next_video);
      setVideoUrl(next_video);
    };
    if (isVideoVisibleBottom(next_video, 356)) {
      playNextVideo();
    } else if (isVideoVisibleBottom(next_video)) {
      scrollToVideo(next_video, playNextVideo);
    } else {
      playNextVideo();
    }
  }
}


function loadMore($more_el) {
  var loading = $more_el.data('loading');
  if (loading) {
    return false;
  }
  var before = $more_el.attr('data-before');
  var after  = $more_el.attr('data-after');
  $more_el.data('loading', true);
  $.ajax('', {
    data: {
      before: before,
      after: after,
    },
    type: 'POST',
    dataType: 'json',
    xhrFields: {
      withCredentials: true,
    },
    success: function(data) {
      if (before) {
        var y = $more_el.offset().top + $more_el.outerHeight(true) - $(document).scrollTop();
        $(data).insertBefore($more_el);
        initVideos();
        var st = $more_el.offset().top - y;
        $more_el.remove();
        $(document).scrollTop(st);
      } else {
        $(data).insertBefore($more_el);
        initVideos();
        $more_el.remove();
      }
    }
  });
}

function scrollToVideo(video, callback) {
  var st = video.$el.offset().top - ($(window).height() - video.$el.height()) / 2;
  var fired = false;
  $('html, body').animate({ scrollTop: st }, 300, function() {
    if (fired) return;
    fired = true;
    callback && callback();
  });
}

function isVideoVisible(video, delta) {
  delta = +delta || 0;
  var top = video.$el.offset().top;
  var doc_bottom = $(document).scrollTop() + $(window).height();
  if (top + delta >= doc_bottom) {
    return false;
  }
  var bottom = top + video.$el.height();
  var doc_top = $(document).scrollTop();
  if (bottom - delta <= doc_top) {
    return false;
  }
  return true;
}

function isVideoVisibleBottom(video, delta) {
  delta = +delta || 0;
  var top = video.$el.offset().top;
  var doc_bottom = $(document).scrollTop() + $(window).height();
  if (top + delta >= doc_bottom) {
    return false;
  }
  return true;
}

function openShareVideo(video) {
  var url = 'https://telesco.pe' + video.$postWrap.attr('data-url');
  var embed_code = '<iframe src="https://telesco.pe/embed' + video.$postWrap.attr('data-url') + '" width="420" height="340" frameborder="0"></iframe>';
  var url_encoded = encodeURIComponent(url);

  var $shareLink = $('.ts-share-link-field');
  $shareLink.text(url);
  var $embedCode = $('.ts-embed-code-field');
  $embedCode.text(embed_code);
  var selectElement = function($el) {
    if (!$el) {
      $el = $('.ts-popup').hasClass('ts-embed-code-shown') ? $embedCode : $shareLink;
    }
    var el = $el.get(0);
    var range = document.createRange();
    range.selectNodeContents(el);
    var sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  };

  $('.ts-share-twitter .ts-share-button').attr('href', 'https://twitter.com/intent/tweet?url=' + url_encoded);
  $('.ts-share-facebook .ts-share-button').attr('href', 'https://www.facebook.com/sharer/sharer.php?u=' + url_encoded);
  $('.ts-share-telegram .ts-share-button').attr('href', 'https://t.me/share/url?url=' + url_encoded);
  $('.ts-share-link-button').off('click').on('click', function(e) {
    e.stopPropagation();
    $('.ts-popup').removeClass('ts-embed-code-shown');
    $('.ts-popup-buttons').removeClass('ts-url-copied');
    selectElement($shareLink);
  });
  $('.ts-embed-code-button').off('click').on('click', function(e) {
    e.stopPropagation();
    $('.ts-popup').addClass('ts-embed-code-shown');
    $('.ts-popup-buttons').removeClass('ts-url-copied');
    selectElement($embedCode);
  });
  $('.ts-popup-copy-url').off('click').on('click', function(e) {
    e.stopPropagation();
    selectElement($shareLink);
    if (document.execCommand('copy')) {
      $('.ts-popup-buttons').addClass('ts-url-copied');
    }
  });
  $('.ts-popup-copy-code').off('click').on('click', function(e) {
    e.stopPropagation();
    selectElement($embedCode);
    if (document.execCommand('copy')) {
      $('.ts-popup-buttons').addClass('ts-url-copied');
    }
  });
  $('.ts-share-button').off('click').on('click', function(e) {
    e.stopPropagation();
    var popupW = 550,
        popupH = 350,
        popupUrl = $(this).attr('href'),
        params = [
          'width=' + popupW,
          'height=' + popupH,
          'left=' + Math.round(screen.width / 2 - popupW / 2),
          'top=' + Math.round(screen.height / 2 - popupH / 2),
          'personalbar=0',
          'toolbar=0',
          'scrollbars=1',
          'resizable=1'
        ].join(','),
        popup = window.open(popupUrl, '_blank', params);
    if (popup) {
      try {
        popup.focus();
      } catch (e) {}
    }
  });
  $('.ts-popup-close').off('click').on('click', function(e) {
    e.stopPropagation();
    closeShareVideo();
  });
  $('.ts-popup-container').addClass('ts-popup-show').off('click').on('click', function(e) {
    selectElement();
  });
  $('.ts-popup-buttons').removeClass('ts-url-copied');
  $(document).on('keydown', onEscapeCloseShareVideo);
  $('body').css('overflow', 'hidden');
  selectElement();
}

function closeShareVideo() {
  $('.ts-popup-container').removeClass('ts-popup-show');
  setTimeout(function() {
    $('.ts-popup').removeClass('ts-embed-code-shown');
  }, 200);
  $(document).off('keydown', onEscapeCloseShareVideo);
  $('body').css('overflow', '');
}

function onEscapeCloseShareVideo(e) {
  if (e.keyCode == 27) {
    closeShareVideo();
  }
}

$(document).on('click', '.ts-post-more', function() {
  var $el = $(this);
  loadMore($el);
});

$(document).ready(function() {
  initVideos();
  if ($('body').hasClass('ts-embed')) return;
  var currentVideo = videoObj($('.ts-post-current'));
  updateHeader();
  $(window).resize(function() {
    updateHeader();
  });
  if (currentVideo.el) {
    scrollToVideo(currentVideo, function() {
      currentVideo.$postWrap.removeClass('ts-post-current');
      initScroll();
    });
  } else {
    $(document).scrollTop($(document).height());
    initScroll();
  }
  window.onpopstate = function(event) {
    var path     = document.location.pathname;
    var feed_url = $('.ts-feed').attr('data-url');
    if (path == feed_url) {
      // nothing
    } else if ((path.indexOf(feed_url + '/') === 0) &&
               +path.substr(feed_url.length + 1)) {
      var video = videoObj($('.ts-post[data-url="' + path + '"]'));
      if (video.el) {
        stopPlayback();
        video.$postWrap.addClass('ts-post-current');
        scrollToVideo(video, function() {
          video.$postWrap.removeClass('ts-post-current');
        });
      } else {
        document.location = document.location;
      }
    } else {
      document.location = document.location;
    }
  };
});
